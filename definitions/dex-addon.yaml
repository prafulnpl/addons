apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: dex-addon
  namespace: vela-system
  annotations:
    definition.oam.dev/description: "DEX OIDC Identity Provider for KubeVela SSO"
spec:
  workload:
    definition:
      apiVersion: apps/v1
      kind: Deployment
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "apps/v1"
          kind:       "Deployment"
          metadata: {
            name:      "dex"
            namespace: "vela-system"
            labels: {
              "app": "dex"
            }
          }
          spec: {
            replicas: 1
            selector: {
              matchLabels: {
                "app": "dex"
              }
            }
            template: {
              metadata: {
                labels: {
                  "app": "dex"
                }
              }
              spec: {
                containers: [{
                  name:  "dex"
                  image: "quay.io/dexidp/dex:v2.36.0"
                  ports: [{
                    containerPort: 5556
                    name:          "http"
                  }]
                  args: [
                    "/usr/local/bin/dex",
                    "serve",
                    "/etc/dex/cfg/config.yaml"
                  ]
                  volumeMounts: [{
                    name:      "config"
                    mountPath: "/etc/dex/cfg"
                  }]
                  env: [
                    {
                      name:  "DEX_OVERWRITE_INTEGRATION_CALLBACKS"
                      value: "true"
                    }
                  ]
                }]
                volumes: [{
                  name: "config"
                  configMap: {
                    name: "dex-config"
                  }
                }]
              }
            }
          }
        }
        
        outputs: {
          service: {
            apiVersion: "v1"
            kind:       "Service"
            metadata: {
              name:      "dex-service"
              namespace: "vela-system"
              labels: {
                "app": "dex"
              }
            }
            spec: {
              selector: {
                "app": "dex"
              }
              ports: [{
                name:       "http"
                port:       5556
                targetPort: 5556
              }]
              type: "ClusterIP"
            }
          }
          configmap: {
            apiVersion: "v1"
            kind:       "ConfigMap"
            metadata: {
              name:      "dex-config"
              namespace: "vela-system"
            }
            data: {
              "config.yaml": """
                issuer: https://pm.datanature.dlytica.com/dex
                
                storage:
                  type: sqlite3
                  config:
                    file: /var/dex/dex.db
                
                web:
                  http: 0.0.0.0:5556
                  allowedOrigins:
                    - https://pm.datanature.dlytica.com
                
                telemetry:
                  http: 0.0.0.0:5558
                
                logger:
                  level: info
                  format: text
                
                oauth2:
                  grantTypes:
                    - password
                    - refresh_token
                    - authorization_code
                    - urn:ietf:params:oauth:grant-type:token-exchange
                  skipApprovalScreen: true
                
                enablePasswordDB: true
                
                staticClients:
                - id: velaux
                  secret: EPj8DLz2eVyt9c5TwQPLTfNFdlua2ytd
                  redirectURIs:
                    - https://pm.datanature.dlytica.com/dex/callback
                  name: VelaUX PM
                  public: false
                
                connectors:
                - type: oidc
                  id: keycloak
                  name: Keycloak
                  config:
                    issuer: https://keycloak.datanature.dlytica.com/realms/master
                    clientID: velaux
                    clientSecret: EPj8DLz2eVyt9c5TwQPLTfNFdlua2ytd
                    redirectURI: https://pm.datanature.dlytica.com/dex/callback
                    scopes:
                      - openid
                      - profile
                      - email
                      - groups
              """
            }
          }
        }